# Теория к Лабораторной работе №3: Физическое проектирование и SQL

В этой лабораторной работе мы переходим от абстрактных моделей к реализации базы данных в конкретной СУБД (PostgreSQL). Мы рассматриваем физическое хранение данных, типы данных, ограничения целостности и базовые операции.

---

## 1. Физическое проектирование

**Физическое проектирование** — это процесс трансформации логической модели данных в структуру, оптимизированную для конкретной СУБД, с учетом требований к производительности и хранению.

### 1.1. Типы данных PostgreSQL
Правильный выбор типа данных критичен для производительности и целостности.

*   **Числовые:**
    *   `INTEGER` (4 байта): Стандартный выбор для счетчиков.
    *   `BIGINT` (8 байт): Для очень больших чисел (ID, если не UUID).
    *   `NUMERIC(p, s)`: Для денег и точных вычислений (хранит числа без погрешности плавающей точки).
    *   `REAL` / `DOUBLE PRECISION`: Числа с плавающей точкой (для физических величин).

*   **Строковые:**
    *   `TEXT`: В PostgreSQL это основной тип для строк любой длины. В отличие от других СУБД, он не медленнее `VARCHAR(n)`.
    *   `VARCHAR(n)`: Используется, только если нужно жестко ограничить длину на уровне БД.

*   **Временные:**
    *   `TIMESTAMP`: Дата и время (без часового пояса).
    *   `TIMESTAMPTZ` (with time zone): Рекомендуемый тип. Хранит время в UTC, конвертирует при выводе.
    *   `INTERVAL`: Хранит промежуток времени (например, "2 дня 5 часов").

*   **Специальные:**
    *   `UUID`: 128-битный идентификатор. Позволяет генерировать уникальные ID на клиенте или распределенно, избегая конфликтов при слиянии баз.
    *   `BOOLEAN`: Истина/Ложь.
    *   `JSONB`: Бинарный JSON. Позволяет хранить неструктурированные данные и индексировать их.

### 1.2. Ограничения целостности (Constraints)
Механизмы, гарантирующие корректность данных.

1.  **PRIMARY KEY (PK):** Уникальный идентификатор строки. Автоматически создает индекс. Не может быть NULL.
2.  **FOREIGN KEY (FK):** Обеспечивает ссылочную целостность. Гарантирует, что значение ссылается на существующую строку в другой таблице.
    *   `ON DELETE CASCADE`: При удалении родителя удаляются и потомки.
    *   `ON DELETE SET NULL`: При удалении родителя ссылка становится NULL.
    *   `ON DELETE RESTRICT`: Запрещает удаление родителя, если есть потомки.
3.  **UNIQUE:** Гарантирует уникальность значения в столбце (или комбинации столбцов).
4.  **CHECK:** Проверяет условие перед вставкой/обновлением.
    *   *Пример:* `CHECK (price > 0)`, `CHECK (end_date > start_date)`.
5.  **NOT NULL:** Запрещает пустые значения.

---

## 2. Язык SQL (Structured Query Language)

### Группы операторов

#### DDL (Data Definition Language)
Определение структуры. Эти операции меняют схему БД.
*   `CREATE TABLE users (...)`
*   `ALTER TABLE users ADD COLUMN age INT`
*   `DROP TABLE users`
*   `TRUNCATE TABLE users` (быстрая очистка таблицы)

#### DML (Data Manipulation Language)
Работа с данными.
*   `INSERT INTO ...`
*   `SELECT ...`
*   `UPDATE ... SET ...`
*   `DELETE FROM ...`

#### TCL (Transaction Control Language)
Управление транзакциями.
*   `BEGIN` / `START TRANSACTION`
*   `COMMIT`: Применить изменения.
*   `ROLLBACK`: Отменить изменения.

---

## 3. Транзакции и ACID

**Транзакция** — это последовательность операций, которая выполняется как единое целое. Либо выполняются все операции, либо ни одной.

Свойства **ACID**:
1.  **Atomicity (Атомарность):** Транзакция неделима. Если ошибка произошла в середине, отменяется всё.
2.  **Consistency (Согласованность):** Транзакция переводит БД из одного корректного состояния в другое (все Constraints соблюдены).
3.  **Isolation (Изолированность):** Параллельные транзакции не должны мешать друг другу (уровень изоляции регулирует это).
4.  **Durability (Долговечность):** Если транзакция закоммичена (`COMMIT`), данные сохранены надежно (даже при сбое питания).

---

## 4. Индексы

**Индекс** — это структура данных (обычно дерево), которая ускоряет поиск (`SELECT`), но замедляет изменение данных (`INSERT`, `UPDATE`, `DELETE`), так как индекс тоже нужно обновлять.

### Типы индексов в PostgreSQL:
*   **B-Tree (Balanced Tree):** Самый универсальный. Подходит для сравнений `=`, `>`, `<`, `>=`, `<=`, `BETWEEN`, `IN`. Используется по умолчанию.
*   **Hash:** Только для сравнения на равенство `=`.
*   **GiST / GIN:** Для полнотекстового поиска, геометрии, массивов и JSONB.

**Когда создавать индекс:**
*   Столбец часто используется in `WHERE`.
*   Столбец используется in `JOIN`.
*   Столбец используется in `ORDER BY`.

---

## 5. Основы выборки данных (DQL)

Хотя `SELECT` формально относится к DML, его часто выделяют в отдельную категорию DQL (Data Query Language).

### 5.1. Сортировка (ORDER BY)
Позволяет упорядочить результаты запроса.
*   `ASC` (по умолчанию): По возрастанию (A-Z, 0-9).
*   `DESC`: По убыванию (Z-A, 9-0).
*   Можно сортировать по нескольким столбцам: `ORDER BY city_id ASC, price DESC`.

### 5.2. Фильтрация (WHERE)
Позволяет выбирать только те строки, которые удовлетворяют условию.

**Операторы сравнения:**
*   `=`: Равно.
*   `<>` или `!=`: Не равно.
*   `>`, `<`, `>=`, `<=`: Больше, меньше и т.д.

**Логические операторы:**
*   `AND`: Оба условия должны быть истинны.
*   `OR`: Хотя бы одно условие истинно.
*   `NOT`: Инверсия условия.

**Специальные операторы:**
*   `IN (val1, val2)`: Значение входит в список.
*   `BETWEEN val1 AND val2`: Значение в диапазоне (включительно).
*   `LIKE 'pattern'`: Поиск по шаблону (`%` - любая строка, `_` - один символ).
    *   `ILIKE`: Регистронезависимый поиск (специфично для PostgreSQL).
*   `IS NULL` / `IS NOT NULL`: Проверка на пустое значение.

---

## 6. Docker и Контейнеризация БД

В проекте мы используем **Docker** для запуска PostgreSQL.

**Преимущества:**
1.  **Изоляция:** База данных работает в своем окружении, не засоряя основную ОС.
2.  **Воспроизводимость:** Файл `docker-compose.yml` гарантирует, что у всех разработчиков будет одинаковая версия БД и настройки.
3.  **Удобство:** Одной командой `docker-compose up` поднимается вся инфраструктура.

**Volumes (Тома):**
Чтобы данные не пропадали при удалении контейнера, мы используем Docker Volumes (маппинг папки на хосте в папку внутри контейнера `/var/lib/postgresql/data`).
