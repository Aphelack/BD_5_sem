# Теория к Лабораторной работе №5: Триггеры и Хранимые процедуры

В этой лабораторной работе мы изучаем серверное программирование в PostgreSQL. Это позволяет перенести часть бизнес-логики непосредственно в базу данных, что повышает производительность и гарантирует целостность данных.

---

## 1. PL/pgSQL

**PL/pgSQL** (Procedural Language/PostgreSQL Structured Query Language) — это процедурное расширение SQL для PostgreSQL. Оно позволяет использовать:
*   Переменные и типы данных.
*   Управляющие конструкции (`IF`, `CASE`, `LOOP`, `WHILE`, `FOR`).
*   Обработку исключений (`EXCEPTION`).
*   Курсоры для построчной обработки результатов.

### Структура блока
```sql
DO $$ 
DECLARE
    counter integer := 0;
BEGIN
    counter := counter + 1;
    RAISE NOTICE 'Counter is %', counter;
END $$;
```

---

## 2. Хранимые функции и Процедуры

В PostgreSQL есть два основных типа именованных блоков кода:

### 2.1. Функции (`CREATE FUNCTION`)
*   **Возвращают значение** (скаляр, запись или таблицу).
*   Могут использоваться внутри SQL-запросов (например, в `SELECT`).
*   Выполняются в рамках транзакции вызывающего запроса.
*   До версии 11 использовались для всего, включая процедуры.

**Пример:**
```sql
CREATE FUNCTION add(a integer, b integer) RETURNS integer AS $$
BEGIN
    RETURN a + b;
END;
$$ LANGUAGE plpgsql;
```

### 2.2. Процедуры (`CREATE PROCEDURE`)
*   **Не возвращают значение** (могут возвращать данные через `INOUT` параметры).
*   Вызываются командой `CALL`.
*   **Могут управлять транзакциями** (`COMMIT`, `ROLLBACK` внутри процедуры). Это главное отличие от функций.

**Пример:**
```sql
CREATE PROCEDURE transfer_money(from_id int, to_id int, amount dec) AS $$
BEGIN
    UPDATE accounts SET balance = balance - amount WHERE id = from_id;
    UPDATE accounts SET balance = balance + amount WHERE id = to_id;
    COMMIT; -- Можно зафиксировать транзакцию
END;
$$ LANGUAGE plpgsql;
```

---

## 3. Триггеры (Triggers)

**Триггер** — это специальная хранимая процедура, которая автоматически выполняется при наступлении определенного события (INSERT, UPDATE, DELETE, TRUNCATE) в таблице или представлении.

### Типы триггеров:
1.  **Row-level (Для каждой строки):** Выполняется для каждой изменяемой строки. Имеет доступ к переменным `NEW` (новое состояние строки) и `OLD` (старое состояние).
2.  **Statement-level (Для оператора):** Выполняется один раз на весь SQL-запрос, независимо от количества затронутых строк.

### Время срабатывания:
*   `BEFORE`: До выполнения операции. Используется для валидации данных или их модификации перед записью.
*   `AFTER`: После выполнения операции. Используется для аудита, обновления связанных таблиц.
*   `INSTEAD OF`: Только для представлений (Views).

**Пример (Автоматическое обновление updated_at):**
```sql
CREATE TRIGGER update_timestamp
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

---

## 4. Курсоры (Cursors)

Курсоры позволяют обходить результат запроса строка за строкой. Это полезно, когда результат слишком велик для загрузки в память целиком или требуется сложная логика обработки каждой строки.

---

## 5. Обработка ошибок

В PL/pgSQL можно перехватывать ошибки, чтобы не прерывать выполнение всей транзакции.

```sql
BEGIN
    INSERT INTO users ...;
EXCEPTION WHEN unique_violation THEN
    -- Обработка дубликата
    RAISE NOTICE 'User already exists';
END;
```
